# "急"按钮点击统计功能 - 部署指南

## 功能说明

为倒计时页面的"急"按钮添加了全局点击统计功能，可以实时显示所有访问网站的用户累计点击次数。

## 实现特性

✅ **全局统计** - 统计所有用户的点击次数
✅ **实时同步** - 使用 Supabase 实时订阅，任何用户点击后所有在线用户都能看到最新数据
✅ **批量上传** - 用户连续点击时先在本地计数，停止点击 2 秒后批量上传，大幅减少服务器负载
✅ **防抖处理** - 防止用户过快重复点击
✅ **降级方案** - 即使 Supabase 未配置，也能使用本地缓存功能
✅ **数据一致性** - 使用原子操作确保并发点击时数据准确
✅ **智能清理** - 页面关闭时自动上传未提交的点击次数

## 部署步骤

### 1. 配置 Supabase 数据库

1. 登录你的 [Supabase 控制台](https://supabase.com/dashboard)
2. 选择你的项目
3. 进入 **SQL Editor**
4. 打开 `supabase-setup-urgent-button.sql` 文件
5. 复制全部 SQL 代码并粘贴到 SQL Editor
6. 点击 **Run** 执行

### 2. 验证数据库设置

在 SQL Editor 中运行以下查询来验证设置：

```sql
-- 查看统计表
SELECT * FROM public.global_stats WHERE key = 'urgent_button_clicks';

-- 测试增加函数
SELECT public.increment_urgent_clicks();
```

### 3. 启用实时更新（可选但推荐）

1. 在 Supabase 控制台进入 **Database** > **Replication**
2. 找到 `global_stats` 表
3. 启用 **Realtime** 功能

## 文件说明

### 新增/修改的文件

1. **`src/services/statsService.js`** (新建)
   - 处理"急"按钮点击统计的 API 服务
   - 包含获取、增加、订阅点击次数的函数
   - 实现了降级方案（本地缓存）

2. **`src/components/home/HomePage.jsx`** (修改)
   - 添加了点击统计的状态管理
   - 集成了实时订阅功能
   - 修改了倒计时组件和"急"按钮

3. **`supabase-setup-urgent-button.sql`** (新建)
   - Supabase 数据库表和函数的创建脚本
   - 包含完整的权限设置和注释

## 功能演示

### 用户体验

1. 用户访问首页，看到公测倒计时
2. 倒计时下方有一个红色的"急"按钮
3. 按钮下方显示全球累计点击次数
4. 点击按钮后：
   - **本地计数立即 +1** （UI 即时响应）
   - 用户可以继续点击，数字持续增加
   - 停止点击 2 秒后，**批量上传所有点击**到服务器
   - 所有在线用户同步看到更新
5. 如果用户关闭页面，未上传的点击会立即提交

### 批量上传优化

**为什么使用批量上传？**

传统方式：每次点击都发送一次请求
```
点击 → 请求1 → 数据库
点击 → 请求2 → 数据库
点击 → 请求3 → 数据库
...（100 次点击 = 100 次请求）
```

优化后：累计点击，延迟批量上传
```
点击 → 本地 +1
点击 → 本地 +1
点击 → 本地 +1
... (用户疯狂点击)
停止 2 秒 → 批量请求(+100) → 数据库
（100 次点击 = 1 次请求！）
```

**性能提升：**
- 减少 99% 的网络请求
- 降低服务器负载
- 提升用户体验（无延迟）
- 减少数据库写入压力

### UI 效果

```
┌─────────────────────────┐
│  公测开启倒计时          │
│  XX 天 XX 时 XX 分 XX 秒 │
│                         │
│        ┌───┐            │
│        │ 急 │ ← 可点击   │
│        └───┘            │
│       12,345  ← 全球点击 │
└─────────────────────────┘
```

## 技术细节

### 数据表结构

```sql
global_stats
├── id (BIGSERIAL, 主键)
├── key (TEXT, 唯一键)
├── value (TEXT, 存储点击次数)
├── created_at (TIMESTAMPTZ)
└── updated_at (TIMESTAMPTZ)
```

### RPC 函数

```sql
increment_urgent_clicks() → TEXT
increment_urgent_clicks_batch(increment_by BIGINT) → TEXT
```

- `increment_urgent_clicks()`: 单次增加（兼容性函数）
- `increment_urgent_clicks_batch()`: 批量增加（优化版）

两个函数都使用 `FOR UPDATE` 锁定行，确保并发安全。

### 安全策略

- **读取**: 任何人都可以读取统计数据
- **更新**: 只能通过 RPC 函数更新（防止直接篡改）
- **插入/删除**: 禁止直接操作

## 故障排除

### 问题1: 点击后数字不更新

**可能原因:**
- Supabase 未正确配置
- 网络连接问题

**解决方案:**
1. 检查 `.env` 文件中的 Supabase 配置
2. 查看浏览器控制台是否有错误信息
3. 即使离线，本地缓存也会工作

### 问题2: 实时更新不生效

**可能原因:**
- 未启用 Realtime 功能
- Supabase 订阅失败

**解决方案:**
1. 在 Supabase 控制台启用 Realtime
2. 检查浏览器控制台的订阅状态
3. 刷新页面重新连接

### 问题3: 数字显示为 0

**可能原因:**
- 数据库未初始化
- 权限配置错误

**解决方案:**
1. 重新执行 SQL 脚本
2. 检查 RLS 策略是否正确设置

## 扩展建议

### 可选增强功能

1. **排行榜** - 显示点击最多的时间段
2. **每日重置** - 每天重置计数器
3. **动画升级** - 不同点击数触发不同特效
4. **成就系统** - 达到特定点击数解锁成就

### 性能优化配置

在 `HomePage.jsx` 中可以调整批量上传的延迟时间：

```javascript
const UPLOAD_DELAY = 2000; // 停止点击后 2 秒上传（默认值）
```

建议值：
- **2000ms (2秒)** - 平衡性能和实时性（推荐）
- **1000ms (1秒)** - 更快的数据同步，但增加请求数
- **3000ms (3秒)** - 更少的请求，但延迟更高

### 其他性能优化建议

1. **CDN 分发** - 将统计数据缓存到 CDN
2. **数据压缩** - 对大量点击数据进行压缩传输

## 许可和鸣谢

此功能基于 Supabase 实时数据库实现，感谢开源社区的支持！

---

**最后更新:** 2025-12-29
**作者:** Claude + 用户协作开发
